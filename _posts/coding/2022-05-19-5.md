---
title:  "데이터베이스"
categories: coding
tag: [php, laravel, migration, seeder]
toc: true
---

## 5-1 마이그레이션

### 마이그레이션 장점
- 형상 관리를 할 수 있다.
- 롤백을 할 수 있다.
- 편리하다.

### 마이그레이션 명령어
- 파일 만들기
    - php artisan make:migration create_테이블명_table
    - database/migrations에 있는 마이그레이션 파일에서 실행 안된것만반영
- 실행
    - php artisan migrate
    - database/migrations에 있는 각 파일 up 함수 실행
    - migrations 테이블에 존재하지 않는 파일을 찾아 생성함
- 롤백:
    - php artisan migrate:rollback
    - 직전 마이그레이션으로 돌아가기
    - migratins 테이블에서 'batch'컬럼 번호가 가장 큰 것들을 롤백 대상으로정함
- 리셋:
    - php artisan migrate:reset
    - 모든 마이그레이션을 원복할때 사용

**SELECT * FROM migrations**

|id|migration|batch|
|-|-----------------------------------------------------|-|
|1|2019_12_14_000001_create_personal_access_tokens_table|1|
|2|2022_05_19_121747_create_authors_table|2|


### 마이그레이션 테이블 생성 파일 예시
```php
class CreateBookdetailsTable extends Migration
{
    // 데이터베이스 정의를 추가(또는 변경)하기 위한 처리 담당
    public function up()
    {
        Schema::create('bookdetails', function (Blueprint $table) {
            $table->id(); // auto_increment
            $table->string('name', '100')->nullable(); //varchar 100길이 제한, null 가능
            $table->integer('book_id')->unsigned(); // 양수
            $table->string('isbn', '100')->default('a'); //기본값 'a'
            $table->date('published_date');
            $table->integer('price')->index(); // 인덱스 설정
            $table->timestamps(); // created_at, updated_at
        });
    }

    // up 메서드의 내용을 원복하는 처리
    public function down()
    {
        Schema::dropIfExists('bookdetails');
    }
}
```

### 마이그레이션 테이블 수정 파일 예시
```php
class RenameBookdetailsTable extends Migration
{
    public function up()
    {
        Schema::table('bookdetails', function (Blueprint $table){
            $table->renameColumn('name', 'change_name');
        });
    }

    public function down()
    {
        Schema::table('bookdetails', function (Blueprint $table){
            $table->renameColumn('change_name', 'name');
        });
    }
}
```

## 5-2 시더

### 시더 장점
- 더미데이터를 쉽게 만들 수 있다.
- 의미없는 데이터가 아닌 구체적인 데이터도 가능하다.

### 시더 명령어
- 파일 만들기
    - php artisan make:seeder 테이블명TableSeeder
    - database/seeder 디렉터리에 만들어짐

### 시더 생성 파일 예시
```php
class BookdetailsTableSeeder extends Seeder
{
    // 더미 데이터 만들 로직 정의 
    public function run()
    {
        for ($i=1; $i<=3; $i++) {
            $bookDetail = [
                'name' => 'name' . $i,
                'book_id' => $i,
                'isbn' => 'isbn' . $i,
                'published_date' => now(),
                'price' => $i,
                'created_at' => now(),
                'updated_at' => now(),
            ];
            DB::table('bookdetails')->insert($bookDetail);
        }
    }
}
```

### 신규 생성한 Seeder 파일 등록하기
```php
class DatabaseSeeder extends Seeder
{
    // 등록된 시더파일 실행시킴
    public function run()
    {
        $this->call(BookdetailsTableSeeder::class);
        // \App\Models\User::factory(10)->create();
    }
}
```

### Factory
- Model의 대량의 데이터를 손쉽게 생성할 수 있다.
- (순서)
    (1) Model 생성 -> php artisan make:테이블명
    (2) Factory 생성 및 정의
        - php artisan make:테이블명Factory
        - Faker를 통해 데이터 정의
    (3) DatabaseSeeder에 해당 Factory 선언
    (4) php artisan db:seed 실행

### Faker란
현실적인 데이터 값을 만들어주는 것(이름, 주소, 이메일등)

### Factory 생성
```php
class PublisherFactory extends Factory
{
    /**
     * The name of the factory's corresponding model.
     *
     * @var string
     */
    protected $model = Publisher::class;

    /**
     * Define the model's default state.
     *
     * @return array
     */
    public function definition()
    {
        return [
            'name' => $this->faker->company,
            'address' => $this->faker->address,
            'created_at' => now(),
            'updated_at' => now(),
        ];
    }
}
```

### 신규 생성한 Factory 파일 등록하기
```php
class DatabaseSeeder extends Seeder
{
    // 등록된 시더파일 실행시킴
    public function run()
    {
        \App\Models\Publisher::factory(10)->create();
    }
}
```